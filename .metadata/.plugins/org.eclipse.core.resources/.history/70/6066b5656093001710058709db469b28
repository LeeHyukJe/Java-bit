package ch16;

import java.net.*;
import java.io.*;
import java.util.*;
import java.sql.*;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.util.Scanner;
import oracle.jdbc.pool.OracleDataSource;

public class ClientTest {
	OracleDataSource ods = null;
	Connection conn = null;
	PreparedStatement pstmt = null;
	ResultSet rs = null;
	String name = "";

	ClientTest() {
		try {
			ods = new OracleDataSource();
			ods.setURL("jdbc:oracle:thin:@localhost:1521:xe");
			ods.setUser("student");
			ods.setPassword("1234");
			conn = ods.getConnection();
			String cName = "select name from student";
			pstmt = conn.prepareStatement(cName);
			rs = pstmt.executeQuery();

			while (rs.next()) {
				name = rs.getString(2);
			}
		} catch (Exception e) {
		}

	}

	public static void main(String[] args) {
		// TODO Auto-generated method stub
		new ClientTest();
		try {
			String serverIP = "192.168.104.26";
			Socket socket = new Socket(serverIP, 7777);
			Thread sender = new Thread(new ClientSender(socket,name));
			Thread receive = new Thread(new ClientReceive(socket));

			sender.start();
			receive.start();
		} catch (Exception e) {
		}
	}

	class ClientSender implements Runnable {
		Socket socket;
		DataOutputStream dos;
		String name;

		ClientSender(Socket socket, String name) {
			this.socket = socket;
			try {
				this.name = name;
				dos = new DataOutputStream(socket.getOutputStream());
			} catch (Exception e) {
			}
		}

		public void run() {
			Scanner sc = new Scanner(System.in);

			try {
				if (dos != null) {
					dos.writeUTF(name);
				}

				while (dos != null) {
					dos.writeUTF("[" + name + "]" + sc.nextLine());
				}
			} catch (Exception e) {
			}
		}
	}

	class ClientReceive implements Runnable {
		Socket socket;
		DataInputStream dis;

		ClientReceive(Socket socket) {
			this.socket = socket;
			try {
				dis = new DataInputStream(socket.getInputStream());
			} catch (Exception e) {
			}
		}

		public void run() {
			try {
				while (dis != null) {
					System.out.println(dis.readUTF());
					try {
						int ok;
						String cData = "insert into student values(?)";
						pstmt = conn.prepareStatement(cData);
						pstmt.setString(1, dis.readUTF().toString());

					} catch (Exception e) {
					}
				}
			} catch (Exception e) {
			}
		}
	}
}